PKG_CXXFLAGS = -I. `PKG_CONFIG_PATH=lib/pkgconfig:$(PKG_CONFIG_PATH) pkg-config --cflags libarchive`
PKG_LIBS = `PKG_CONFIG_PATH=lib/pkgconfig:$(PKG_CONFIG_PATH) pkg-config --static --libs libarchive`

.PHONY: all libarchive clean

all: $(OBJECTS) $(SHLIB)
  @echo $(PKG_CXXFLAGS)
  @echo $(PKG_LIBS)

$(OBJECTS): info libarchive

info: libarchive
	@echo "# PKG_CXXFLAGS: '$(PKG_CXXFLAGS)'"
	@echo "# PKG_LIBS: '$(PKG_LIBS)'"

libarchive-3.3.1/Makefile:
	(cd libarchive-3.3.1 && \
./configure \
CC="$(CC)" \
CFLAGS="$(CFLAGS) $(CPICFLAGS)" \
AR="$(AR)" \
ARFLAGS=$(ARFLAGS) \
--enable-shared=no \
--enable-static=yes \
--prefix=$(PWD) \
--disable-bsdtar \
--disable-bsdcat \
--disable-bsdcpio \
--disable-maintainer-mode)

libarchive: libarchive-3.3.1/Makefile
	(cd libarchive-3.3.1 && \
make libarchive.la libarchive_fe.la && \
make install-includeHEADERS install-libLTLIBRARIES install-pkgconfigDATA)

clean:
	rm -f $(OBJECTS) $(SHLIB)
	rm -rf include lib
	(cd libarchive-3.3.1 && \
make distclean)
